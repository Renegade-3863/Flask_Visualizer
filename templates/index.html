<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... 现有的 head 内容 ... -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>检测到的文件</h1>
    <button id="resumeDetection">继续检测</button>
    <ul id="fileList" class="file-list">
        <!-- 文件列表将通过 JavaScript 动态更新 -->
    </ul>

    <script>
        let checkingNewFiles = true;

        function createFileElement(file) {
            const li = document.createElement('li');
            li.className = 'file-item';
            li.dataset.filePath = file.path;

            const strong = document.createElement('strong');
            strong.textContent = file.name;
            li.appendChild(strong);

            if (file.type === '.mp4') {
                const video = document.createElement('video');
                video.width = 320;
                video.height = 240;
                video.controls = true;

                const source = document.createElement('source');
                source.src = `/uploads/${file.path}`;
                source.type = 'video/mp4';

                video.appendChild(source);
                li.appendChild(video);
            } else if (['.pdf', '.doc', '.docx'].includes(file.type)) {
                const a = document.createElement('a');
                a.href = `/uploads/${file.path}`;
                a.target = '_blank';
                a.textContent = '查看文档';
                li.appendChild(a);
            }

            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-file';
            deleteButton.textContent = '删除';
            li.appendChild(deleteButton);

            return li;
        }

        function updateFileList(files) {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = ''; // 清空现有列表
            files.forEach(file => {
                fileList.appendChild(createFileElement(file));
            });
        }

        function checkNewFiles() {
            if (!checkingNewFiles) return;

            axios.get('/get_new_files')
                .then(response => {
                    const data = response.data;
                    if (data.status === "paused") {
                        checkingNewFiles = false;
                        console.log("检测已暂停");
                        alert("检测到新文件，检测已暂停。请查看新文件并点击'继续检测'按钮以恢复检测。");
                        updateFileList(data.files); // 更新文件列表
                    } else {
                        updateFileList(data); // 更新文件列表
                        setTimeout(checkNewFiles, 5000);
                    }
                })
                .catch(error => {
                    console.error('Error fetching new files:', error);
                    setTimeout(checkNewFiles, 5000);
                });
        }

        document.getElementById('resumeDetection').addEventListener('click', function() {
            axios.get('/resume_detection')
                .then(response => {
                    const data = response.data;
                    if (data.status === "resumed") {
                        console.log("检测已恢复");
                        alert("检测已恢复，系统将继续监控新文件");
                        checkingNewFiles = true;
                        checkNewFiles();
                    }
                })
                .catch(error => {
                    console.error('Error resuming detection:', error);
                });
        });

        document.getElementById('fileList').addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-file')) {
                const li = e.target.closest('li');
                const filePath = li.dataset.filePath;

                axios.post('/delete_file', { file_path: filePath })
                    .then(response => {
                        const data = response.data;
                        if (data.status === 'success') {
                            li.remove();
                            alert(data.message);
                        } else {
                            alert('删除失败：' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting file:', error);
                        alert('删除失败：发生错误');
                    });
            }
        });

        checkNewFiles(); // 开始检查新文件
    </script>
</body>
</html>