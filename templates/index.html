<!DOCTYPE html>
<html lang="en">
<head>
    <!-- introduce the axios library, used for doing http request-->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/styles.css"> <!-- using css as the render of the webpage -->
    <style>
    #container {
        display: flex;
    }
    #preview-container {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border: 1px solid #ccc;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        z-index: 1000;
    }
    #preview-content {
        max-height: 400px;
        overflow-y: auto;
    }
    #latest-file-display {
        display: block; /* 初始状态为显示 */
        position: fixed; /* 修改为固定定位 */
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(1.5); /* 居中并放大 */
        border: 2px solid red;
        padding: 10px;
        background-color: #f9f9f9;
        z-index: 1000; /* 提高层级 */
    }
    #button-list {
        width: 20%;
        padding: 20px;
        box-sizing: border-box;
    }
    #content {
        width: 80%;
        padding: 20px;
        box-sizing: border-box;
    }
    #fileList {
        margin-top: 20px;
    }
    </style>
</head>
<body>
    <h1>Fall Detection</h1>
    <div id="container">
        <div id="button-list">
            <button id="toggleLatestFile" style="display: block; margin-bottom: 20px;">close the latest file display</button>
            <button id="resumeDetection" style="display: block; margin-bottom: 20px;">continue detection</button>
            <button id="pauseObservation" style="display: block; margin-bottom: 20px;">pause detection</button>
            <button id="getDetectionChart" style="display: block; margin-bottom: 20px;">Get Detection Chart</button>
            <button id="toggleChart" style="display: block; margin-bottom: 20px;">Show Detection Chart</button>
            <input type="date" id="chartDate" style="display: block; margin-bottom: 20px;">
        </div>
        <div id="content">
            <div id="latest-file-display"></div>
            <ul id="fileList" class="file-list">
                <!-- 文件列表将通过 JavaScript 动态更新 -->
            </ul>
        </div>
        <div id="chart-container" style="display: none;">
            <!-- <button id="close-chart">Close Chart</button> -->
            <img id="detectionChart" style="display: block; margin-top: 20px;" />
        </div>
    </div>
    <img id="detectionChart" style="display: none; margin-top: 20px;" />
    <div id="preview-container">
        <button id="close-preview">close preview</button>
        <div id="preview-content"></div>
    </div>

    <script>
        let checkingNewFiles = true;

        function createFileElement(file, isLatest = false) {
            const li = document.createElement('li');
            li.className = 'file-item';
            li.dataset.filePath = file.path;

            const strong = document.createElement('strong');
            strong.textContent = file.name;
            li.appendChild(strong);
            console.log('File type:', file.type);

            if (file.type === '.mp4') {
                const video = document.createElement('video');
                video.width = 320;
                video.height = 240;
                video.controls = true;

                const source = document.createElement('source');
                source.src = `/uploads/${file.path}`;
                source.type = 'video/mp4';

                video.appendChild(source);
                li.appendChild(video);
            } else {
                // Do nothing when other files arrives
            }

            if (!isLatest) {
                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-file';
                deleteButton.textContent = 'Delete';
                li.appendChild(deleteButton);
            }

            return li;
        }

        document.getElementById('pauseObservation').addEventListener('click', function() {
                axios.post('/pause_observation')
                .then(response => {
                    const data = response.data;
                    if (data.status === "paused") {
                        console.log("detection has been paused manually");
                        alert(data.message);
                        checkingNewFiles = false;
                        document.getElementById('pauseObservation').disabled = true;
                        document.getElementById('resumeDetection').disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error pausing observation:', error);
                    alert('observation failed: ' + (error.response ? error.response.data.error : error.message));
                });
        });

        document.getElementById('getDetectionChart').addEventListener('click', function() {
            const date = document.getElementById('chartDate').value;
            alert(date);
            if (!date) {
                alert('Please select a date');
                return;
            }
            // alert('Selected date:', date);
            axios.get('/get_detection_chart', {params:{date: date}})
                .then(response => {
                    const chart = document.getElementById('detectionChart');
                    const timestamp = new Date().getTime();
                    chart.src = '/static/detection_chart.png?t=' + timestamp;
                    chart.style.display = 'block';
                    document.getElementById('chart-container').style.display = 'block';
                    document.getElementById('toggleChart').textContent = 'Hide Detection Chart';
                })
                .catch(error => {
                    console.error('Error fetching detection chart:', error);
                    alert('Failed to fetch detection chart');
                });
        });

        function updateFileList(files) {
            const fileList = document.getElementById('fileList');
            const latestFileContainer = document.getElementById('latest-file-display');
            fileList.innerHTML = ''; // 清空现有列表
            latestFileContainer.innerHTML = ''; // 清空最新文件显示

            // 按照文件的创建时间降序排序（最新的文件在前）
            files.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            files.forEach((file, index) => {
                const fileElement = createFileElement(file);
                fileList.appendChild(fileElement);

                // 将最新的文件放大显示
                if (index === 0) {
                    latestFileContainer.appendChild(createFileElement(file, true));
                }
            });
        }

        function checkNewFiles() {
            if (!checkingNewFiles) return;

            axios.get('/get_new_files')
                .then(response => {
                    const data = response.data;
                    if (data.status === "paused") {
                        checkingNewFiles = false;
                        console.log("检测已暂停");
                        // alert 添加当前时间戳

                        alert("New file detected on " + new Date().toLocaleString() + ", the automatic detection has been paused, press on continue detection to continue");
                        document.getElementById('pauseObservation').disabled = true;
                        document.getElementById('resumeDetection').disabled = false;
                        // 显示最新文件
                        document.getElementById('latest-file-display').style.display = 'block';
                        // 更新显示最新文件的按钮状态
                        document.getElementById('toggleLatestFile').textContent = 'close the latest file display';
                        updateFileList(data.files); // 更新文件列表
                    } else {
                        updateFileList(data); // 更新文件列表
                        setTimeout(checkNewFiles, 5000);
                    }
                })
                .catch(error => {
                    console.error('Error fetching new files:', error);
                    setTimeout(checkNewFiles, 5000);
                });
        }
        
        document.getElementById('close-preview').addEventListener('click', function() {
            document.getElementById('preview-container').style.display = 'none';
            document.getElementById('preview-content').innerHTML = '';
        });

        document.getElementById('resumeDetection').addEventListener('click', function() {
            axios.get('/resume_detection')
                .then(response => {
                    const data = response.data;
                    if (data.status === "resumed") {
                        console.log("detection restored");
                        alert("detection restored, the system will continue to monitor new files");
                        checkingNewFiles = true;
                        checkNewFiles();
                        // 更新 UI
                        document.getElementById('pauseObservation').disabled = false;
                        document.getElementById('resumeDetection').disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error resuming detection:', error);
                    alert('detection restoration failed' + (error.response ? error.response.data.error : error.message));
                });
        });

        document.getElementById('fileList').addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-file')) {
                const li = e.target.closest('li');
                const filePath = li.dataset.filePath;

                axios.post('/delete_file', { file_path: filePath })
                    .then(response => {
                        const data = response.data;
                        if (data.status === 'success') {
                            li.remove();
                            alert(data.message);
                        } else {
                            alert('deletion failed:' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting file:', error);
                        alert('deletion failed: error generated');
                    });
            }
        });

        document.getElementById('toggleLatestFile').addEventListener('click', function() {
            const latestFileContainer = document.getElementById('latest-file-display');
            if (latestFileContainer.style.display === 'none') {
                latestFileContainer.style.display = 'block';
                this.textContent = 'close the latest file display';
            } else {
                latestFileContainer.style.display = 'none';
                this.textContent = 'open the latest file display';
            }
        });

        document.getElementById('toggleChart').addEventListener('click', function() {
        const chartContainer = document.getElementById('chart-container');
            if (chartContainer.style.display === 'none') {
                chartContainer.style.display = 'block';
                this.textContent = 'Hide Detection Chart';
            } else {
                chartContainer.style.display = 'none';
                this.textContent = 'Show Detection Chart';
            }
        });

        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById('resumeDetection').disabled = true;
            document.getElementById('pauseObservation').disabled = false;
            document.getElementById('preview-container').style.display = 'none';
            document.getElementById('preview-content').innerHTML = '';
        })

        checkNewFiles(); // 开始检查新文件
    </script>
</body>
</html>